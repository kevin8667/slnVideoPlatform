@model PlaylistViewModel

<div class="container-fluid">
    <div class="row-top">
        <div class="col-12 d-flex align-items-center my-3 position-relative">
            <div>
                <a href="javascript:void(0);" class="btn btn-success" onclick="createPlaylist()">新增</a>
            </div>            
            <div class="position-absolute top-50 start-50 translate-middle">
                <div id="table-selector" class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" id="btn-playlists">播放清單</button>
                    <button type="button" class="btn btn-outline-secondary" id="btn-items">播放清單內容</button>
                    <button type="button" class="btn btn-outline-success" id="btn-memberPlaylists">會員播放清單</button>
                    <button type="button" class="btn btn-outline-info" id="btn-collaborators">片單協作者</button>
                </div>
            </div>
            <div class="d-flex ms-auto">
                <div id="search-bar" class="d-flex align-items-center">
                    <input id="search-box" type="text" placeholder="搜尋關鍵字" class="form-control me-2" style="height: 38px; width: 120px;" />
                    <button id="btn-search-box" class="btn btn-dark" style="height: 38px;">搜尋</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-light p-3 shadow-sm">
        <div id="topbar" class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">                
                <select id="page-size-select" class="form-select me-2" aria-label="每頁顯示筆數" style="height: 38px;" onchange="changePageSize(event)">
                    <option value="1">每頁1筆資料</option>
                    <option selected value="5">每頁5筆資料</option>
                    <option value="10">每頁10筆資料</option>
                    <option value="15">每頁15筆資料</option>
                    <option value="20">每頁20筆資料</option>
                    <option value="25">每頁25筆資料</option>
                </select>
            </div>            
            <div class="me-auto">
                <nav aria-label="Page navigation example">
                    <ul class="pagination mb-0">
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>            
            <div class="d-flex align-items-center">
                <select class="form-select me-2" aria-label="排序方式" style="height: 38px;" onchange="changeSort(event)">
                    <option value="ascPlayListId">播放ID升冪</option>
                    <option value="descPlayListId">播放ID降冪</option>
                    <option value="ascPlayListName">播放清單名稱升冪</option>
                    <option value="descPlayListName">播放清單名稱降冪</option>
                    <option value="ascCreatedAt" selected>創建日期升冪</option>
                    <option value="descCreatedAt">創建日期降冪</option>
                </select>
            </div>
        </div>
    </div>

    <div class="row-content">
        <div id="content" class="col-12">
            <div id="playlists" class="content-panel">
                @await Html.PartialAsync("_PlayListPartial", Model.PlayLists)
            </div>
            <div id="items" class="content-panel d-none">
                @await Html.PartialAsync("_PlayListItemPartial", Model.PlayListItems)
            </div>
            <div id="memberPlaylists" class="content-panel d-none">
                @await Html.PartialAsync("_MemberPlayListPartial", Model.MemberPlayLists)
            </div>
            <div id="collaborators" class="content-panel d-none">
                @await Html.PartialAsync("_PlayListCollaboratorPartial", Model.PlayListCollaborators)
            </div>
        </div>
    </div>
</div>

<div id="popup-window" class="position-fixed bg-white shadow-lg rounded" style="width: 400px; height: 400px; display: none; bottom: 0; right: 120px;">
    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
        <h5 id="popup-title" class="m-0">Title</h5>
        <button type="button" class="btn-close" aria-label="Close" onclick="closePopup()"></button>
    </div>
    <div id="popup-content" class="p-3 overflow-auto" style="height: calc(100% - 60px);">
        <!-- 右下角視窗預計顯示的地方 -->
    </div>
</div>

@section Scripts
{
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#table-selector button').on('click', function () {
                var targetUrl = '';

                switch (this.id) {
                    case 'btn-playlists':
                        targetUrl = '@Url.Action("LoadPlayListPartial", "Playlist")';
                        break;
                    case 'btn-items':
                        targetUrl = '@Url.Action("LoadPlayListItemPartial", "Playlist")';
                        break;
                    case 'btn-memberPlaylists':
                        targetUrl = '@Url.Action("LoadMemberPlayListPartial", "Playlist")';
                        break;
                    case 'btn-collaborators':
                        targetUrl = '@Url.Action("LoadPlayListCollaboratorPartial", "Playlist")';
                        break;
                }

                if (targetUrl !== '') {
                    $.ajax({
                        url: targetUrl,
                        type: 'GET',
                        success: function (data) {
                            $('#content').html(data);
                        },
                        error: function () {
                            alert('Failed to load data.');
                        }
                    });
                }
            });
        });

        function showPopup(title, contentUrl) {
            $('#popup-title').text(title);
            $.ajax({
                url: contentUrl,
                type: 'GET',
                success: function (data) {
                    $('#popup-content').html(data);
                    $('#popup-window').show();
                },
                error: function () {
                    alert('Failed to load content.');
                }
            });
        }

        function closePopup() {
            $('#popup-window').hide();
        }

        function showDetails(id) {
            var url = '/Playlist/PlayListDetails/' + id;
            showPopup('清單', url);
        }

        function editPlaylist(id) {
            var url = '/Playlist/PlayListEdit/' + id;
            showPopup('編輯', url);
        }

        function createPlaylist() {
            var url = '/Playlist/PlayListCreate';
            showPopup('新增', url);
        }

        function deletePlaylist(id) {
            if (confirm('確定要刪除嗎？')) {
                $.ajax({
                    url: '/Playlist/PlayListDeleteConfirmed/' + id,
                    type: 'POST',
                    success: function (data) {
                        $('#content').html(data);
                    },
                    error: function (xhr, status, error) {
                        alert('刪除失敗: ' + xhr.responseText);
                    }
                });
            }
        };

        $(document).ready(function () {
            $("#btn-search-box").click(function () {
                var searchTerm = $("#search-box").val();
                $.ajax({
                    url: '@Url.Action("FilterPlayLists", "Playlist")',
                    type: 'GET',
                    data: { searchTerm: searchTerm },
                    success: function (result) {
                        $("#content").html(result);
                    },
                    error: function () {
                        alert('error');
                    }
                });
            });
        });

        var currentPage = 1;
        var pageSize = 10;
        var sortOrder = "asc";
        var sortBy = "PlayListId";

        function loadPlaylists() {
            $.ajax({
                url: '@Url.Action("LoadPagedPlayLists", "Playlist")',
                type: 'GET',
                data: {
                    page: currentPage,
                    pageSize: pageSize,
                    sortBy: sortBy,
                    sortOrder: sortOrder
                },
                success: function (result) {
                    $('#content').html(result.html);
                    updatePagination(result.totalPages);
                },
                error: function () {
                    alert('Failed to load data.');
                }
            });
        }

        function changePageSize(event) {
            pageSize = $(event.target).val();
            currentPage = 1;
            loadPlaylists();
        }

        function changeSort(event) {
            var value = $(event.target).val();
            sortOrder = value.includes("asc") ? "asc" : "desc";

            if (value.includes("PlayListId")) {
                sortBy = "PlayListId";
            } else if (value.includes("PlayListName")) {
                sortBy = "PlayListName";
            } else {
                sortBy = "PlayListCreatedAt";
            }

            currentPage = 1;
            loadPlaylists();
        }

        function updatePagination(totalPages) {
            var pagination = $('.pagination');
            pagination.empty();

            if (totalPages <= 1) {
                pagination.hide();
                return;
            }

            pagination.show();

            if (currentPage > 1) {
                pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">&laquo;</a></li>');
            }
            
            if (totalPages <= 10) {
                for (var i = 1; i <= totalPages; i++) {
                    var activeClass = i === currentPage ? ' active' : '';
                    pagination.append('<li class="page-item' + activeClass + '"><a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a></li>');
                }
            } else {                
                if (currentPage <= 4) {
                    for (var i = 1; i <= 5; i++) {
                        var activeClass = i === currentPage ? ' active' : '';
                        pagination.append('<li class="page-item' + activeClass + '"><a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a></li>');
                    }
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                    pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(' + totalPages + ')">' + totalPages + '</a></li>');
                } else if (currentPage > totalPages - 4) {
                    pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>');
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                    for (var i = totalPages - 4; i <= totalPages; i++) {
                        var activeClass = i === currentPage ? ' active' : '';
                        pagination.append('<li class="page-item' + activeClass + '"><a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a></li>');
                    }
                } else {
                    pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>');
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                    for (var i = currentPage - 2; i <= currentPage + 2; i++) {
                        var activeClass = i === currentPage ? ' active' : '';
                        pagination.append('<li class="page-item' + activeClass + '"><a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a></li>');
                    }
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                    pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(' + totalPages + ')">' + totalPages + '</a></li>');
                }
            }

            if (currentPage < totalPages) {
                pagination.append('<li class="page-item"><a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">&raquo;</a></li>');
            }
        }

        function changePage(page) {
            currentPage = page;
            loadPlaylists();
        }

        $(document).ready(function () {
            loadPlaylists();
        });

    </script>
}